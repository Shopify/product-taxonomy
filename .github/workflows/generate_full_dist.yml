name: Generate and commit all distribution files

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: "full_dist"
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate_full_dist:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up short SHA
      id: short_sha
      run: echo "::set-output name=sha::$(git rev-parse --short ${{ github.sha }})"

    - name: Get last committer username
      id: last_committer
      run: |
        LAST_COMMIT_SHA=$(git log -1 --pretty=format:'%H')
        API_URL="https://api.github.com/repos/${{ github.repository }}/commits/${LAST_COMMIT_SHA}"
        COMMITTER_LOGIN=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $API_URL | jq -r '.committer.login')
        echo "::set-output name=username::$COMMITTER_LOGIN"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1

    - name: Install Cue
      uses: cue-lang/setup-cue@v1.0.0
      with:
        version: 'v0.7.0'

    - name: Install bundler and gems
      run: |
        gem install bundler
        bundle install --jobs 4 --retry 3

    - name: Generate distribution files
      run: make VERBOSE=1 LOCALES=fr

    - name: Commit changes and create PR
      id: cpr   # Get the result of this step
      uses: peter-evans/create-pull-request@v6
      with:
        commit-message: "ðŸ¤– Update localization files for ${{ github.sha }}"
        branch: "localization-dist-${{github.sha}}"
        branch-suffix: short-commit-hash
        title: "ðŸ¤– Update localization files for ${{ steps.short_sha.outputs.sha }}"
        body: "Update `dist/` localization files. Triggered by ${{ steps.short_sha.outputs.sha }}. cc @${{ steps.last_committer.outputs.username }}"
        labels: automated-pr, localization
        assignees: ${{ steps.last_committer.outputs.username }}
