#!/usr/bin/env ruby

require 'date'
require 'json'
require 'yaml'

require_relative '../src/category'

VERSION = File.read("VERSION").strip

class GenerateDist
  def initialize
    @verticals = Dir.glob("data/categories/*.yml").each_with_object({}) do |file, hash|
      file_name = File.basename(file, ".yml")
      data = YAML.load_file(file)
      hash[file_name] = data
    end
    @category_trees = @verticals.map do |_, categories|
      categories.map { |category| Category.from_json(category) }
    end
  end

  def generate_category_txt
    categories_as_text = @category_trees.flat_map { _1.map(&:to_s) }
    header_version = "#{Date.today} (#{VERSION})"

    File.open("dist/categories.txt", "w") do |file|
      file.write("# Shopify Product Taxonomy: #{header_version}\n")
      file.write(categories_as_text.join("\n"))
    end
  end

  def generate_category_json
    output = {
      version: VERSION,
      verticals: @category_trees.map do |tree|
        vertical_root = tree.first
        {
          name: vertical_root.name,
          prefix: vertical_root.id.downcase,
          categories: tree.map(&:to_full_hash),
        }
      end
    }
    File.open("dist/categories.json", "w") do |file|
      file.write(JSON.pretty_generate(output))
    end
  end

  private

  def category_to_text(category)
    "#{category["public_id"]} : #{category["fully_qualified_type"]}"
  end
end

dist = GenerateDist.new

dist.generate_category_txt
dist.generate_category_json
