#!/usr/bin/env ruby

require 'date'
require 'json'
require 'yaml'

VERSION = File.read("VERSION").strip

class GenerateDist
  def initialize
    @categories = Dir.glob("data/categories/*.yml").each_with_object({}) do |file, hash|
      file_name = File.basename(file, ".yml")
      data = YAML.load_file(file)
      hash[file_name] = data
    end
  end

  def generate_category_txt
    categories_as_text = @categories.transform_values { |c| c.map { category_to_text(_1) } }
    header_version = "#{Date.today} (#{VERSION})" 
    categories_as_text.each do |filename, data|
      File.open("dist/categories/#{filename}.txt", 'w') do |file|
        file.write("# Shopify #{humanize(filename.sub(/.*?_/, ""))} Product Taxonomy: #{header_version}\n")
        file.write(data.join("\n"))
      end
    end

    File.open("dist/categories.txt", "w") do |file|
      file.write("# Shopify Product Taxonomy: #{header_version})\n")
      file.write(categories_as_text.values.flatten.join("\n"))
    end
  end

  def generate_category_json
    output = {
      version: VERSION,
      verticals: @categories.map do |vertical_id, categories|
        vertical = categories.first
        {
          name: vertical["name"],
          prefix: vertical["public_id"].downcase,
          categories: categories
        }
      end
    }
    File.open("dist/categories.json", "w") do |file|
      file.write(JSON.pretty_generate(output))
    end
  end

  private

  def humanize(string)
    string.split("_").map(&:capitalize).join(" ")
  end

  def category_to_text(category)
    "#{category["public_id"]} : #{category["fully_qualified_type"]}"
  end
end
  
dist = GenerateDist.new

dist.generate_category_txt
dist.generate_category_json
